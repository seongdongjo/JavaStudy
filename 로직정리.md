#) 수입오더관리 청구금계산<br>
먼저 청구금계산 로직은 거래처청구요율 메뉴에서 거래처,츨발지,도착지,수출입,type,<br>
20F,20E,40F,40E,45F,45E,적용일자~마감일자사이 같은게 있으면 해당 금액을 컨테이너의 청구금액으로 넣는다.<br>

수입오더에서 헤더를 클릭했을 때 현재 이렇게 오더번호를 넣고있다.(qcellClick함수)
```
<input type="hidden" name="headerOrderNo" id="headerOrderNo">

왜 오더번호를 넘기냐??

> 아래처럼 오더헤더에서 거래처코드를 가져와야한다. 오더디테일 테이블에는 거래처코드가 없기때문에
  이렇게 오더번호를 가져오면 오더헤더에(TRORDR)있는 오더번호에 맞는 거래처코드를 가져올 수 있다. 

    <select id="importSelectOrderCust" parameterType="TRImportTrordtVO" resultType="String">
            SELECT CUST_CODE FROM TRCGEA WHERE 
                CUST_CODE = (SELECT CUST_CODE FROM TRORDR WHERE ORDER_NO = #{orderNo})
                AND PICKUP_JY= #{jydetail1Code}
                AND RETURN_JY= #{jydetail2Code}
                AND CNTR_TYPE = #{cntrTp}
                AND IN_OUT = 'I'
                ORDER BY CUST_APLDAT DESC LIMIT 1
    </select>
```

<img src="https://github.com/seongdongjo/JavaStudy/blob/main/%EB%A1%9C%EC%A7%81%EC%A0%95%EB%A6%AC/1.PNG" width="600" height="100" /><br><br>
여기서 핵심은 수정,추가,변경사항이 없어도 청구금계산을 클릭하면 청구금액이 들어가야한다는 것이다.<br>
```
//청구금계산
	function countClamAmt() {
		var nRow = qcell_master.getIdx("row");
		if(nRow == -1) {
			alert('오더를 선택해주세요.')
			return false;
		}
		//변경이 일어났을때 청구금계산누르면 기본적으로 컨테이너번호 유무 체크 
		var notRegistCost = 0;
		var change = qcell_detail.getStates();
		if(change.i.length != 0 || change.u.length != 0){
			let insertArray = JSON.parse(document.getElementById('paramValue').value).i;
			let updateArray = JSON.parse(document.getElementById('paramValue').value).u;
			let deleteArray = JSON.parse(document.getElementById('paramValue').value).d;
			var arrI = new Array();
			var arrU = new Array();
			var arrD = new Array();

			if(insertArray.length > 0) {
				for(var k = 0; k<insertArray.length; k++) {
					if(insertArray[k].data.cntrNo == '' || insertArray[k].data.cntrNo == null) {
						alert('컨테이너 번호는 빈값이 될 수 없습니다.')
						qcell_detail.hideProgress(300); // progress 화면 출력
						return false;	
					}
					if(insertArray[k].data.cntrNo.replace(/\s| /gi,'') == '') {
						alert('컨테이너 번호는 빈값이 될 수 없습니다.')
						qcell_detail.hideProgress(300); // progress 화면 출력
						return false;					
					}
				}
			}
	
			//수정컨테이너번호담기위해
            //왜 담느냐?? -> 이미 청구금액 로직을 탄 컨테이너는 또 청구금액 로직을 태우면안된다.
            //현재 로직은 수정변화가 없다라는 분기문이 없어서 이렇게 수정변화가 있는 컨테이너는 
            //따로, 담아서 또 청구금액 로직을 안타게 하기 위해서이다.
			var updateCntr;
			if(updateArray.length > 0) {
				for(var z = 0; z<updateArray.length; z++) {
						updateCntr += updateArray[z].data.cntrNo;
						if(z != updateArray.length -1) {
							updateCntr += ","
						}else {
							
						}
					}
				document.getElementById('updateCntr').value = updateCntr;
			}
			qcellChange_detail();
			var formData = decodeURIComponent($('#frm0').serialize());
			$.ajax({
				url: "/transcls/order/importOrderMng/importOrderCountClaim.do", //통신하실 URL 주소(밑에 참조)
				//data: { param: JSON.stringify(states) }, //서버에 param이라는 parameter명으로 JSON String형태로 수정 정보 전달
				async:false,
				data: formData,
				method: "POST" //post형식으로 전달
			}).success(function (data) {
				//qcell_detail.showProgress(); // progress 화면 출력
				if(data.status == "fail") {
					qcell_detail.hideProgress(300); // progress 화면 출력
					alert('에러가 발생하였습니다.')
					return false;
				}
                //data.gridList[i] 안에는 추가,수정데이터에서 청구금액만 넣은 결과이다.
				//삽입했을때의 청구금계산
					if(insertArray.length > 0) {
						for(var k = 0; k<insertArray.length; k++) {
							for(var i = 0; i<data.gridList.length; i++) {
								if(insertArray[k].data.cntrNo == data.gridList[i].cntrNo) { //내가 추가한 컨테이너번호와 가져온 컨테이너번호가 같으면 claim넣음
									qcell_detail.setCellDataEx(insertArray[k].row,'claimAmt',data.gridList[i].claimAmt)
									data.gridList.splice(i,1); //i번째부터 1개지우겠다. 지우는이유는 이미 청구금액이 그리드에 들어간것은 굳이 다시 비교할필요가 없다.
								}
							}
						}
					}
					if(updateArray.length > 0) {
						for(var z = 0; z<updateArray.length; z++) {
							for(var x = 0; x<data.gridList.length; x++) {
								//data.gridList[x]에는 청구금이 0원인 한줄이 들어가있다. 
								if(updateArray[z].data.cntrNo == data.gridList[x].cntrNo) { //컨테이너번호로 같으면 가져온다.
									qcell_detail.setCellDataEx(updateArray[z].row,'claimAmt',data.gridList[x].claimAmt)
									data.gridList.splice(x,1); //지우는이유는 이미 청구금액이 그리드에 들어간것은 굳이 다시 비교할필요가 없다.
								}
							}
						}
					}
					notRegistCost += data.count;
			}).error(function (xhr, status, error) {
				qcell_detail.hideProgress(300); // progress 화면 출력
				alert("오류가 발생하였습니다.");
				//실패시 처리
			});
		}
```
#)컨트롤러
```
/**
     * 오더관리 > 수입(detail) - 청구금계산(변경사항이있으면서 0원일때)
     * @param Map<String,Object> vo
     * @return 출력페이지정보 "selectImportOrderMng"
     * @exception Exception
     */
    @NoLogging				 
	@RequestMapping(value = "/transcls/order/importOrderMng/importOrderCountClaim.do")
	public@ResponseBody HashMap<String, Object> importOrderCountClaim(@ModelAttribute("tRImportTrOrdtVO") TRImportTrordtVO tRImportTrOrdtVO, @RequestParam Map<String,Object> vo, ModelMap model) throws Exception {
    	LoginVO user = (LoginVO) EgovUserDetailsHelper.getAuthenticatedUser();
    	HashMap<String, Object> resMap = new HashMap<String, Object>();
    	List<TRImportTrordtVO> detailCountClaim = new ArrayList<TRImportTrordtVO>();
		try {	
			tRImportTrOrdtVO.setLoginJijum(user.getJijum()); 
            //파라미터를 보면 tRImportTrOrdtVO안에는 headerOrderNo가 들어가있다.
            //detailCountClaim은 리스트를 impl에서 받아오기 위해 넘겼다. 
			int count = importOrderMngService.importCountClaim(vo,tRImportTrOrdtVO,detailCountClaim);
				Function fn = new Function();
				JSONArray jsonArr = null;
				resMap.put("gridList", detailCountClaim);
				resMap.put("count", count);
		}catch(Exception e) {
			resMap.put("status", "fail");
			e.printStackTrace();
		}
		return resMap;
	}
```
#)impl
```
/**
     * 오더관리 디테일 저장 전 청구요율에 거래처가 있는지 확인
     * @param Map<String,Object> vo
     * @return 출력페이지정보 "selectimportOrderMng"
     * @exception Exception
     */
	@SuppressWarnings({ "unchecked", "unused" })
	@Override
	public int importCountClaim(Map<String, Object> vo,TRImportTrordtVO tRImportTrOrdtVO,List<TRImportTrordtVO> gridList) throws Exception {
		
		LoginVO user = (LoginVO)EgovUserDetailsHelper.getAuthenticatedUser(); // 현재 로그인한 계정정보 가져오기
		
		Map<String,Object> paramMap = new HashMap<String,Object>();
		List<Map<String,Object>> list = new ArrayList<Map<String,Object>>();
		ObjectMapper objectMapper2 = new ObjectMapper();
		Function fn = new Function();
		
		String strParam = (String) vo.get("param"); //화면상에 form -> name 값 사용
		paramMap = fn.jsonToMap(strParam);
		int count = 0; //기간이 틀린 건수(거래처청구요율에 해당하는 값은 있지만)
		
		//수정 데이터
		list = (List<Map<String, Object>>) paramMap.get("u");
		TRImportTrordtVO gridU = new TRImportTrordtVO();
		
		String custCode = null;
		double claimAmt = 0.0;
		
		if(list.size() > 0) { 
			for(int i=0; i < list.size(); i++) {
				gridU = objectMapper2.convertValue(fn.mapToVo(list,i), TRImportTrordtVO.class);
				//한줄마다의 상,하차지에 맞는 청구요율에서 거래처코드 가져오기(한줄마다의 gridU에는 오더번호,상,하차지가있다)
				custCode = importOrderMngDAO.importSelectOrderCust(gridU);
				gridU.setCustCode(custCode);
				gridU.setLoginJijum(user.getJijum()); // VO에 로그인 지점 값 넣기
				gridU.setLoginId(user.getId()); // VO에 로그인 ID 값 넣기
				gridU.setLoginIp(user.getIp()); // VO에 로그인 IP 값 넣기
				if(custCode == null || custCode == "") {
					//청구요율에 해당하는 거래처코드 자체가 없다면
					//문제점: tRImportTrOrdtVO에 계속 custCode, 저장되는현상
				}else { //거래처청구요율에 상,하차지,(오더의)거래처코드가 있다면
					if(gridU.getClaimAmt() == 0.0) {//입력안했을 때만
						//계약기간비교해서 거래처코드를 가져온다(아래count비교를 위해)
						custCode = importOrderMngDAO.importCheckOrderCust(gridU);
						//계약기간이 지나면 count = 0;
						if(custCode == null || custCode == "") {
							//tRImportTrOrdtVO.setCustCode(gridU.getCustCode()); //거래처코드 미리 저장해놓고(메시지출력위해)
							//tRImportTrOrdtVO.setJydetail1Code(gridU.getJydetail1Code()); 
							//tRImportTrOrdtVO.setJydetail2Code(gridU.getJydetail2Code()); 
							//tRImportTrOrdtVO.setCntrTp(gridU.getCntrTp());
							count++; //기간이 오버된거 count증가
							//return count;
						}else {
							claimAmt = importOrderMngDAO.importSelectClaimAmt(gridU);
							gridU.setClaimAmt(claimAmt);
							//i가 else문을 타면 띄엄띄엄 들어가서 i안쓰고 차곡차곡넣음
							gridList.add(gridU);
						}
					}
				}
			}
		}
		//입력 데이터
				list = (List<Map<String, Object>>) paramMap.get("i");
				TRImportTrordtVO gridI = new TRImportTrordtVO();
				if(list.size() > 0) { 
					//0으로 하는 이유는 컨테이너 오더번호는 같으니 그냥 첫번째걸로 구함
					//gridI = objectMapper2.convertValue(fn.mapToVo(list,0), TRImportTrordtVO.class);
					//해당하는 오더번호에 대한 거래처 가져옴(여기서는 계약일자는 비교하지않음)
					//custCode = importOrderMngDAO.importSelectOrderCust(gridI);
					//이렇게 count분기를 하는 이유는 alert를 3가지 case로 띄우기 위해서다.
					for(int i=0; i < list.size(); i++) {
						gridI = objectMapper2.convertValue(fn.mapToVo(list,i), TRImportTrordtVO.class);
						custCode = importOrderMngDAO.importSelectOrderCust(gridI);
						gridI.setCustCode(custCode);
						gridI.setLoginJijum(user.getJijum()); // VO에 로그인 지점 값 넣기
						gridI.setLoginId(user.getId()); // VO에 로그인 ID 값 넣기
						gridI.setLoginIp(user.getIp()); // VO에 로그인 IP 값 넣기
						if(custCode == null || custCode == "") {
						//청구요율에 해당하는 거래처코드 자체가 없다면
						}else { //거래처청구요율에 상,하차지,(오더의)거래처코드가 같다면
							custCode = importOrderMngDAO.importCheckOrderCust(gridI);
							//계약기간이 지나면 count = 0;
							if(custCode == null || custCode == "") {
								//tRImportTrOrdtVO.setCustCode(gridI.getCustCode()); //거래처코드 미리 저장해놓고(메시지출력위해)
								//tRImportTrOrdtVO.setJydetail1Code(gridI.getJydetail1Code()); 
								//tRImportTrOrdtVO.setJydetail2Code(gridI.getJydetail2Code());
								//tRImportTrOrdtVO.setCntrTp(gridI.getCntrTp());
								count++;
								//return count;
							}else {
								claimAmt = importOrderMngDAO.importSelectClaimAmt(gridI);
								gridI.setClaimAmt(claimAmt);
								gridList.add(gridI);
							}
						}
					}
				}
				return count;
	}
```
#)xml
```
<!-- 오더번호에 대한 거래처 가져오기(그리드변경사항일때) -->
	<select id="importSelectOrderCust" parameterType="TRImportTrordtVO" resultType="String">
     	SELECT CUST_CODE FROM TRCGEA WHERE 
			   CUST_CODE = (SELECT CUST_CODE FROM TRORDR WHERE ORDER_NO = #{orderNo})
			   AND PICKUP_JY= #{jydetail1Code}
			   AND RETURN_JY= #{jydetail2Code}
			   AND CNTR_TYPE = #{cntrTp}
			   AND IN_OUT = 'I'
			   ORDER BY CUST_APLDAT DESC LIMIT 1
     </select>

     <!-- 오더번호에 대한 거래처 가져오기 -->
	<select id="importCheckOrderCust" parameterType="TRImportTrordtVO" resultType="String">
     	SELECT CUST_CODE FROM TRCGEA
     	<![CDATA[ 
			   WHERE CUST_CODE = #{custCode} 
			   			  AND PICKUP_JY= #{jydetail1Code}
			   			  AND RETURN_JY= #{jydetail2Code}
			   			  AND CNTR_TYPE = #{cntrTp}
				 		  AND (SELECT DATE_FORMAT(SYSDATE(),'%Y%m%d')) >= CUST_APLDAT
				 		  AND (SELECT DATE_FORMAT(SYSDATE(),'%Y%m%d')) <= CONTRACT_TO
				 		  AND IN_OUT = 'I'
				 		  ORDER BY CUST_APLDAT DESC LIMIT 1
		]]>
     </select>

      <!-- 청구요율의 청구금액 가져오기 -->
	<select id="importSelectClaimAmt" parameterType="TRImportTrordtVO" resultType="_double">
     	SELECT
     		<choose>
				 	<when test='"40".equals(cntrSz) and "F".equals(cntrFe)'>
				 	  	C_40FULL_AMT
				 	</when>
				 	<when test='"40".equals(cntrSz) and "E".equals(cntrFe)'>
				 	  	C_40EMPTY_AMT
				 	</when>
				 	<when test='"20".equals(cntrSz) and "F".equals(cntrFe)'>
				 	  	C_20FULL_AMT
				 	</when>
				 	<when test='"20".equals(cntrSz) and "E".equals(cntrFe)'>
				 	  	C_20EMPTY_AMT
				 	</when>
				 	<when test='"45".equals(cntrSz) and "F".equals(cntrFe)'>
				 	  	C_45FULL_AMT
				 	</when>
				 	<when test='"45".equals(cntrSz) and "E".equals(cntrFe)'>
				 	  	C_45EMPTY_AMT
				 	</when>
			</choose>
			FROM TRCGEA
			<![CDATA[
				 	WHERE CUST_CODE = #{custCode}
				 		  AND PICKUP_JY= #{jydetail1Code}
			   			  AND RETURN_JY= #{jydetail2Code}
				 		  AND (SELECT DATE_FORMAT(SYSDATE(),'%Y%m%d')) >= CUST_APLDAT
				 		  AND (SELECT DATE_FORMAT(SYSDATE(),'%Y%m%d')) <= CONTRACT_TO
				 		  AND IN_OUT = 'I'
				 		  ORDER BY CUST_APLDAT DESC LIMIT 1
			]]>
			
     </select>
```
> 여기까지가 상태변화(수정,추가)일때

#)그러나, 상태변화에 따른 분기를 할수가없어서 수정데이터는 컨테이너를 담아놓고 청구금액 로직을 안타게 만들었다. 위에 로직이 있다.
```
        //변경이없을 때라고 로직을 짯지만 사실 일단 0원기준으로
		//상태변화 상관없이 디비에 그냥 접근한다. 0원기준으로 가져온다.
		//formData를 넣는이유는 검색항목에 input hidden에서 headerOrderNo를 헤더클릭할때 넣어놨다.
			var formData = decodeURIComponent($('#frm0').serialize());
			$.ajax({
				url: "/transcls/order/importOrderMng/importOrderSaveCountClaim.do", //통신하실 URL 주소
				data: formData,
				async:false,
				method: "POST" //post형식으로 전달
			}).success(function (data) {
				if(data.status == "fail") {
					//qcell_detail.hideProgress(300); // progress 화면 출력
					alert('에러가 발생하였습니다.')
					return false;
				}
					var findRow;
					//컨테이너번호만 비교하면된다. 청구금액이 0원인지는 이미 자바단에서 걸럿음
					for(var i=0; i<data.gridList.length; i++) {
						//0원인 로우정보를 가져와서 컨테이너번호기준으로 그리드에서 청구금액을 넣기 위한 해당 로우를 찾는다. 
						findRow = qcell_detail.findRow(data.gridList[i].cntrNo,1,5);
						qcell_detail.setCellDataEx(findRow,'claimAmt',data.gridList[i].claimAmt)
					}
					notRegistCost += data.saveCount
					//qcell_detail.hideProgress(300); // progress 화면 출력
			}).error(function (xhr, status, error) {
				qcell_detail.hideProgress(300); // progress 화면 출력
				alert("오류가 발생하였습니다.");
				//실패시 처리
			});
			if(notRegistCost > 0) {
				alert("거래처 청구요율에 계약기간이 유효하지 않은 데이터가 "+notRegistCost+"건 발생하였습니다.");
			}
```
#)controller
```
/**
     * 오더관리 > 수입(detail) - 청구금계산
     * @param Map<String,Object> vo
     * @return 출력페이지정보 "selectImportOrderMng"
     * @exception Exception
     */
    @NoLogging				 
	@RequestMapping(value = "/transcls/order/importOrderMng/importOrderSaveCountClaim.do")
	public@ResponseBody HashMap<String, Object> importOrderSaveCountClaim(@ModelAttribute("tRImportTrOrdtVO") TRImportTrordtVO tRImportTrOrdtVO, @RequestParam Map<String,Object> vo, ModelMap model) throws Exception {
    	LoginVO user = (LoginVO) EgovUserDetailsHelper.getAuthenticatedUser();
    	HashMap<String, Object> resMap = new HashMap<String, Object>();
    	List<TRImportTrordtVO> saveCountClaim = new ArrayList<TRImportTrordtVO>();
		try {	
			
			tRImportTrOrdtVO.setLoginJijum(user.getJijum()); 
			//기존에 저장되있는 디테일에서 청구금계산눌렀을 때
			//saveCountClaim(리스트)를 넘기는이유는 청구금을계산해서 담기위해
			int saveCount = importOrderMngService.importSaveCountClaim(tRImportTrOrdtVO,saveCountClaim);
				Function fn = new Function();
				JSONArray jsonArr = null;
				resMap.put("gridList", saveCountClaim);
				resMap.put("saveCount", saveCount);
		}catch(Exception e) {
			resMap.put("status", "fail");
			e.printStackTrace();
		}
		return resMap;
	}
```
#)impl
```
/**
     * 오더관리 디테일 저장 전 청구요율에 거래처가 있는지 확인
     * @param TRImportTrordtVO tRImportTrOrdtVO
     * @return 출력페이지정보 "selectimportOrderMng"
     * @exception Exception
     */
	@SuppressWarnings({ "unchecked", "unused" })
	@Override
	public int importSaveCountClaim(TRImportTrordtVO tRImportTrOrdtVO,List<TRImportTrordtVO> gridList) throws Exception {
		
		LoginVO user = (LoginVO)EgovUserDetailsHelper.getAuthenticatedUser(); // 현재 로그인한 계정정보 가져오기

		int count = 0;
		List<TRImportTrordtVO> zeroCountClaimGridList = null;
		
		//저장되있는 컨테이너 중에 0원인 청구금액의 그리드에 청구금액을 변경해서 담을것이다. 
		TRImportTrordtVO zeroCountClaimGrid = new TRImportTrordtVO();
		
		String custCode = null;
		String custCodeMessage = null;
		double claimAmt = 0.0;
		String[] arr;
		//오더번호를 이용해서 청구요율에서 가져온 custCode는 상,하차,tp까지 같아야 가져온다.
		//상,하차,tp를 가져오려면 오더번호를 이용해서 디테일을 가져와야한다. 디테일이 0원인것만
		zeroCountClaimGridList = importOrderMngDAO.importSelectZeroSaveDetail(tRImportTrOrdtVO);
		if(tRImportTrOrdtVO.getUpdateCntr() != null) { //수정한컨테이너가 있다면
			arr = tRImportTrOrdtVO.getUpdateCntr().split(",");
			//수정한 컨테이너들은 제외
			for(int i = 0; i<zeroCountClaimGridList.size(); i++) {
				for(int j = 0; j<arr.length; j++) {
					if(arr[j].equals(zeroCountClaimGridList.get(i).getCntrNo())) {
						zeroCountClaimGridList.remove(i);
					}
				}
			}
		}//수정한컨테이너들은 제외한 0원 한줄
			for(int i = 0; i<zeroCountClaimGridList.size(); i++) {
				custCode = importOrderMngDAO.importSelectSaveOrderCust(zeroCountClaimGridList.get(i));
				//custCodeMessage = custCode;
				if(custCode == null || custCode == "") {
					//날짜제외 오더에서구한 거래처,상,하차지,tp가 일치하는게 없다면 청구요율에 해당하는 거래처코드 자체가 없다면 그냥 아무알람안띄움
				}else { //거래처청구요율에 상,하차지,(오더의)거래처코드가 있다면
					//계약기간비교해서 거래처코드를 가져온다
					zeroCountClaimGridList.get(i).setCustCode(custCode);
					custCodeMessage = importOrderMngDAO.importCheckSaveOrderCust(zeroCountClaimGridList.get(i));
					//계약기간이 지나면 count = 0;
					if(custCodeMessage == null || custCodeMessage == "") {
						//tRImportTrOrdtVO.setCustCode(custCode); //거래처코드 미리 저장해놓고(메시지출력위해)
						//tRImportTrOrdtVO.setJydetail1Code(zeroCountClaimGridList.get(i).getJydetail1Code()); 
						//tRImportTrOrdtVO.setJydetail2Code(zeroCountClaimGridList.get(i).getJydetail2Code()); 
						//tRImportTrOrdtVO.setCntrTp(zeroCountClaimGridList.get(i).getCntrTp());
						count++; //몇건이 기간에 안맞는지.
					}else {
						claimAmt = importOrderMngDAO.importSelectClaimAmt(zeroCountClaimGridList.get(i));
						zeroCountClaimGridList.get(i).setClaimAmt(claimAmt);
						gridList.add(zeroCountClaimGridList.get(i));
					}
				}
			}
			return count;
	}
```
#)xml
```
<!-- 오더번호에 매칭되는 디테일 가져오기(청구금계산을위해) -->
	<select id="importSelectZeroSaveDetail" parameterType="TRImportTrordtVO" resultType="TRImportTrordtVO">
     	SELECT
			A.OR_DATE
  		   ,B.ORDER_NO
 	 	   ,B.TRANS_DATE
  		   ,UPPER(B.CNTR_NO) AS cntrNo
  		   ,B.CNTR_SZ
  		   ,B.CNTR_TP
  		   ,B.CNTR_FE
  		   ,B.CNTR_SEAL
  		   ,B.CNTR_SEAL2
  		   ,B.PICKUP_JY AS jydetail1Code
  		   ,B.RETURN_JY AS jydetail2Code
  		   ,B.AREA_JY AS jydetail3Code
  		   ,(select c_kname FROM TRBACD WHERE c_head='JY' AND c_detail=B.PICKUP_JY) AS jydetail1Name
  		   ,(select c_kname FROM TRBACD WHERE c_head='JY' AND c_detail=B.RETURN_JY) AS jydetail2Name
  		   ,(select c_kname FROM TRBACD WHERE c_head='JY' AND c_detail=B.AREA_JY) AS jydetail3Name
  		   ,B.CLAIM_AMT
  		   ,B.COMBIN
  		   ,B.BACA_ID AS userId
  		   ,B.BACA_NAME AS userName
  		   ,B.REMARK
  		   ,B.INSERT_ID
		FROM TRORDR A, TRORDT B
		WHERE B.ORDER_NO = A.ORDER_NO  
		AND   A.OR_DIVISION = 'I' 
		AND   B.ORDER_NO = #{headerOrderNo}
		AND   B.JIJUM = #{loginJijum}
		AND   B.CLAIM_AMT = 0
     </select>

     <!-- 오더번호에 대한 거래처 가져오기(저장되있는) -->
	<select id="importSelectSaveOrderCust" parameterType="TRImportTrordtVO" resultType="String">
     	SELECT CUST_CODE FROM TRCGEA WHERE 
			   CUST_CODE = (SELECT CUST_CODE FROM TRORDR WHERE ORDER_NO = #{orderNo})
			   AND PICKUP_JY= #{jydetail1Code}
			   AND RETURN_JY= #{jydetail2Code}
			   AND CNTR_TYPE = #{cntrTp}
			   AND IN_OUT = 'I'
			   ORDER BY CUST_APLDAT DESC LIMIT 1
     </select>

     <!-- 위와 차이는 위에꺼는 날짜를 비교하지않고 거래처가 있는지만 비교한다. -->
     <select id="importCheckSaveOrderCust" parameterType="TRImportTrordtVO" resultType="String">
     	SELECT CUST_CODE FROM TRCGEA
     	<![CDATA[ 
			   WHERE CUST_CODE = #{custCode} 
			   			  AND PICKUP_JY= #{jydetail1Code}
			   			  AND RETURN_JY= #{jydetail2Code}
			   			  AND CNTR_TYPE = #{cntrTp}
				 		  AND (SELECT DATE_FORMAT(SYSDATE(),'%Y%m%d')) >= CUST_APLDAT
				 		  AND (SELECT DATE_FORMAT(SYSDATE(),'%Y%m%d')) <= CONTRACT_TO
				 		  AND IN_OUT = 'I'
				 		  ORDER BY CUST_APLDAT DESC LIMIT 1
		]]>
     </select>
```